package de.fayard.refreshVersions.core.internal

internal data class Toml(
    val sections: MutableMap<TomlSection, List<TomlLine>>
) {

    override fun toString() = format()

    internal operator fun set(section: TomlSection, lines: List<TomlLine>) {
        sections[section] = lines
    }

    internal operator fun get(section: TomlSection): List<TomlLine> =
        sections.get(section) ?: emptyList()

    private fun format(): String = buildString {
        initializeRoot()
        for (section in sortedSections()) {
            val lines = get(section)
            if (lines.isNotEmpty()) {
                if (section != TomlSection.Root) append("\n[$section]\n\n")
                append(lines.toText().trim())
                append("\n")
            }
        }
    }

    private fun sortedSections() =
        (TomlSection.sectionOrder + sections.keys).toSet()

    private fun initializeRoot() {
        if (get(TomlSection.Root).isEmpty()) {
            this[TomlSection.Root] = listOf(
                TomlLine(TomlSection.Root, "## Generated by \$ ./gradlew refreshVersionsCatalog"),
                TomlLine.newLine,
            )
        }
    }
}

